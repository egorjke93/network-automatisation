# Исправления от 15.01.2026

## Обзор

Исправлены баги из файла `ошибки.txt`. Добавлены тесты для предотвращения регрессий.

---

## 1. Interface enabled логика (show-diff и sync)

### Проблема
Порты в NetBox показывались как `enabled=False` даже если они административно включены, но просто не имеют линка (not connected).

**Было (неправильно):**
```python
enabled = intf.status == "up"  # down → False, но down = просто нет кабеля!
```

**Стало (правильно):**
```python
enabled = intf.status not in ("disabled", "error")  # down → True (порт включён)
```

### Исправленные файлы
- `netbox/diff.py:323` - логика сравнения enabled
- `netbox/sync/interfaces.py:140,203` - логика создания/обновления enabled

### Логика
| Статус | enabled | Описание |
|--------|---------|----------|
| `up` | `True` | Порт включён, линк есть |
| `down` | `True` | Порт включён, линка нет (not connected) |
| `disabled` | `False` | Administratively down (shutdown) |
| `error` | `False` | err-disabled |

### Тесты
- `tests/test_fixes/test_interface_enabled.py` - 7 тестов
  - `test_enabled_logic_values` - проверка всех статусов
  - `test_diff_compare_interface_enabled` - тест DiffCalculator
  - `test_sync_interface_enabled_mapping` - тест sync логики
  - `test_status_normalization` - проверка STATUS_MAP
  - `test_admin_down_preserved_as_disabled` - критический тест
  - `test_enabled_flow_admin_down` - E2E тест admin down
  - `test_enabled_flow_not_connected` - E2E тест not connected

---

## 2. Preview вывод в веб-интерфейсе

### Проблема
Вывод `~5=94` был непонятен - непонятно что значат числа.

### Решение
Добавлены текстовые метки к числам:
- `+5 new` (создано)
- `~3 upd` (обновлено)
- `-2 del` (удалено)
- `10 skip` (пропущено)

### Исправленные файлы
- `frontend/src/views/Sync.vue` - все stat-card блоки

### Тесты
- `tests/test_fixes/test_sync_preview.py` - 14 тестов
  - `test_summary_format` - формат summary
  - `test_summary_no_changes` - пустой summary
  - `test_total_changes_count` - подсчёт изменений
  - И др.

---

## 3. Platform mapping (импорт из NetBox)

### Проблема
При импорте устройств из NetBox с platform slug `cisco_iosxe` (с underscore) маппинг не срабатывал, потому что в NETBOX_TO_SCRAPLI_PLATFORM были только варианты с дефисом.

### Решение
Добавлены варианты с underscore в `NETBOX_TO_SCRAPLI_PLATFORM`:
```python
"cisco_iosxe": "cisco_ios",
"cisco_nxos": "cisco_nxos",
"arista_eos": "arista_eos",
...
```

### Исправленные файлы
- `core/constants.py` - NETBOX_TO_SCRAPLI_PLATFORM

### Тесты
- `tests/test_fixes/test_platform_mapping.py` - 10 тестов
  - `test_common_platforms_mapping` - основные платформы
  - `test_underscore_variants` - варианты с underscore
  - `test_fallback_returns_original` - fallback поведение
  - И др.

---

## 4. STATUS_MAP - errdisabled

### Проблема
Статус `errdisabled` (без дефиса) не маппился в `error`.

### Решение
Добавлен вариант в STATUS_MAP:
```python
"errdisabled": "error",  # вариант без дефиса
```

### Исправленные файлы
- `core/domain/interface.py` - STATUS_MAP

---

## Сводка изменений

### Изменённые файлы
| Файл | Изменение |
|------|-----------|
| `netbox/diff.py` | Логика enabled (status not in) |
| `netbox/sync/interfaces.py` | Логика enabled (status not in) |
| `core/domain/interface.py` | STATUS_MAP + errdisabled |
| `core/constants.py` | NETBOX_TO_SCRAPLI_PLATFORM + underscore |
| `frontend/src/views/Sync.vue` | Метки для stats |
| `frontend/src/components/DataTable.vue` | JSON export |

### Новые тесты
| Файл | Кол-во тестов |
|------|---------------|
| `tests/test_fixes/test_interface_enabled.py` | 7 |
| `tests/test_fixes/test_platform_mapping.py` | 10 |
| `tests/test_fixes/test_sync_preview.py` | 14 |
| **Итого** | **31** |

### Запуск тестов
```bash
cd /home/sa/project
source network_collector/myenv/bin/activate
python -m pytest network_collector/tests/test_fixes/ -v
```

---

## Что осталось проверить

1. **Сбор данных для импортированных устройств** - нужно протестировать на реальных устройствах
2. **Apply Changes в вебе** - убедиться что dry_run=False действительно применяет изменения
3. **Логирование ошибок** - ошибки коллекторов нужно показывать в UI, а не только в логах

---

## Коммиты

1. `b3fa427` - Fix: interface enabled logic - distinguish admin-down from no-link
2. `8918c59` - Feature: добавлен экспорт в JSON в DataTable
